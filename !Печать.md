### **Синтаксис Dockerfile**  
**Dockerfile** — это текстовый файл с инструкциями для сборки Docker-образа. Каждая инструкция создаёт слой в образе.  

---

## **Основные инструкции**  

### **1. `FROM`**  
Определяет базовый образ для сборки.  
```dockerfile
FROM ubuntu:22.04          # Официальный образ Ubuntu
FROM python:3.9-slim       # Образ Python с минимальными зависимостями
FROM alpine:latest         # Минималистичный образ (~5 МБ)
```

**Важно**:  
- Должна быть **первой инструкцией** (кроме комментариев и `ARG`).  
- Лучше указывать конкретную версию (`python:3.9`, а не `python:latest`).  

---

### **2. `RUN`**  
Выполняет команды внутри контейнера при сборке.  
```dockerfile
RUN apt-get update && apt-get install -y curl  # Установка curl в Ubuntu
RUN pip install flask                          # Установка Python-пакета
```

**Оптимизация**:  
- Объединяйте команды через `&&` и `\` для уменьшения количества слоёв.  
- Чистите кэш (`apt-get clean`, `rm -rf /var/lib/apt/lists/*`).  

---

### **3. `COPY` и `ADD`**  
Копируют файлы из хоста в контейнер.  

#### **`COPY` (рекомендуется)**  
```dockerfile
COPY ./app.py /app/          # Копирует файл app.py в /app/
COPY requirements.txt /tmp/  # Копирует requirements.txt в /tmp/
```

#### **`ADD` (редко используется)**  
Поддерживает распаковку архивов (`*.tar`, `*.gz`) и загрузку по URL.  
```dockerfile
ADD https://example.com/file.tar.gz /tmp/  # Скачивает и распаковывает
ADD data.tar.gz /data/                    # Распаковывает локальный архив
```

**Разница**:  
- `COPY` — только копирование.  
- `ADD` — дополнительные возможности, но менее предсказуем.  

---

### **4. `WORKDIR`**  
Устанавливает рабочую директорию для последующих команд (`RUN`, `CMD`, `COPY`).  
```dockerfile
WORKDIR /app      # Переходит в /app
RUN pwd           # Выведет /app
```

**Аналог** `cd` в Linux.  

---

### **5. `ENV`**  
Устанавливает переменные окружения.  
```dockerfile
ENV PYTHONPATH=/app
ENV FLASK_APP=app.py
```

**Использование**:  
```dockerfile
RUN echo $FLASK_APP  # Доступны в сборке и в запущенном контейнере
```

---

### **6. `EXPOSE`**  
Документирует порт, который контейнер будет слушать.  
```dockerfile
EXPOSE 80      # Контейнер слушает порт 80
EXPOSE 443     # И порт 443
```

**Важно**:  
- Не открывает порт автоматически! Для этого нужно `-p` в `docker run`.  

---

### **7. `CMD` и `ENTRYPOINT`**  
Определяют команду, которая запускается при старте контейнера.  

#### **`CMD`**  
```dockerfile
CMD ["python", "app.py"]          # Запускает app.py (можно переопределить)
CMD ["flask", "run", "--host=0.0.0.0"]
```

#### **`ENTRYPOINT`**  
```dockerfile
ENTRYPOINT ["python", "app.py"]    # Базовый процесс (переопределяется сложнее)
```

**Разница**:  
- `CMD` — аргументы можно переопределить (`docker run my-image flask run`).  
- `ENTRYPOINT` — жёстко фиксирует команду.  

**Комбинирование**:  
```dockerfile
ENTRYPOINT ["python"]
CMD ["app.py"]    # Можно переопределить: docker run my-image server.py
```

---

### **8. `ARG` и `ENV`**  
#### **`ARG`**  
Переменные, доступные **только во время сборки**.  
```dockerfile
ARG VERSION=latest
FROM python:$VERSION
```

#### **`ENV`**  
Доступны и в сборке, и в запущенном контейнере.  

---

### **9. `VOLUME`**  
Создаёт точку монтирования для внешних данных.  
```dockerfile
VOLUME /data      # Данные в /data сохраняются вне контейнера
```

**Используется** для БД, кэша и т.д.  

---

## **Пример Dockerfile**  
```dockerfile
# Базовый образ
FROM python:3.9-slim

# Установка переменных окружения
ENV PYTHONUNBUFFERED=1

# Рабочая директория
WORKDIR /app

# Копирование зависимостей и их установка
COPY requirements.txt .
RUN pip install -r requirements.txt

# Копирование кода
COPY . .

# Открываем порт
EXPOSE 8000

# Команда для запуска
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "app:app"]
```

---

## **Лучшие практики**  
1. **Минимизируйте количество слоёв**: объединяйте `RUN`-команды.  
2. **Используйте `.dockerignore`**: исключайте ненужные файлы (`.git`, `__pycache__`).  
3. **Выбирайте легковесные образы** (`alpine`, `-slim`).  
4. **Не запускайте процессы от root**:  
   ```dockerfile
   RUN useradd -m appuser && chown -R appuser /app
   USER appuser
   ```

---

## **Сборка и запуск**  
```bash
docker build -t my-app .          # Сборка образа
docker run -p 8000:8000 my-app    # Запуск контейнера
```

**Вывод**:  
Dockerfile — это набор инструкций для создания образа. Правильная структура ускоряет сборку и уменьшает размер образа.