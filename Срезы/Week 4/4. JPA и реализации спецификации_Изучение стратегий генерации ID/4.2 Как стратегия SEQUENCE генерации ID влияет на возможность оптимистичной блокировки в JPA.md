## ‚öôÔ∏è –ö–æ—Ä–æ—Ç–∫–æ –æ –º–µ—Ö–∞–Ω–∏–∑–º–∞—Ö
### üîπ `@Version` (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞)
–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç **–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ —Å—É—â–Ω–æ—Å—Ç–∏**.
–ü—Ä–∏–º–µ—Ä:
```java
@Entity
public class Author {

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = "author_seq")
    @SequenceGenerator(name = "author_seq", sequenceName = "author_seq", allocationSize = 1)
    private Long id;

    @Version
    private Long version;

    private String name;
}
```
Hibernate –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `version = 0`;
- –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ ‚Üí —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç `version` –Ω–∞ `1`;
- –ø—Ä–∏ `UPDATE` –¥–æ–±–∞–≤–ª—è–µ—Ç —É—Å–ª–æ–≤–∏–µ `WHERE version = ?` ‚Üí –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π 0, –∑–Ω–∞—á–∏—Ç –∫—Ç–æ-—Ç–æ —É–∂–µ –∏–∑–º–µ–Ω–∏–ª —Å—É—â–Ω–æ—Å—Ç—å, –∏ –±—Ä–æ—Å–∞–µ—Ç—Å—è `OptimisticLockException`.
## üß© –ì–¥–µ –∑–¥–µ—Å—å —É—á–∞—Å—Ç–≤—É–µ—Ç `SEQUENCE`
### üî∏ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å `SEQUENCE`
–ü—Ä–∏ `GenerationType.SEQUENCE` **Hibernate –ø–æ–ª—É—á–∞–µ—Ç ID –¥–æ –≤—Å—Ç–∞–≤–∫–∏**:
```sql
select nextval('author_seq');
```
‚Üí –¢–æ –µ—Å—Ç—å ID –∏–∑–≤–µ—Å—Ç–µ–Ω **–µ—â—ë –¥–æ `INSERT`**, –∞ –∑–Ω–∞—á–∏—Ç:
- Hibernate –º–æ–∂–µ—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤ –ø–∞–º—è—Ç–∏,
- –ú–µ—Ö–∞–Ω–∏–∑–º `@Version` —É–∂–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–º–µ–Ω—ë–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º `INSERT`.
## üí° –í–ª–∏—è–Ω–∏–µ –Ω–∞ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É

|–ê—Å–ø–µ–∫—Ç|–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `SEQUENCE`|–í–ª–∏—è–Ω–∏–µ –Ω–∞ `@Version`|
|---|---|---|
|üßÆ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –¥–æ –≤—Å—Ç–∞–≤–∫–∏|Hibernate –∑–Ω–∞–µ—Ç ID –∑–∞—Ä–∞–Ω–µ–µ|Hibernate –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –ø—Ä–∏–≤—è–∑–∞—Ç—å –≤–µ—Ä—Å–∏—é –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É ID|
|üß© –û—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ (batch insert)|–í–æ–∑–º–æ–∂–Ω—ã|–í–µ—Ä—Å–∏—è –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –¥–æ –≤—Å—Ç–∞–≤–∫–∏ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è|
|‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º `@Version`|–ù–µ–∑–∞–≤–∏—Å–∏–º –æ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID|–†–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ, –Ω–æ **—Å `SEQUENCE` –Ω–∞–¥—ë–∂–Ω–µ–µ –ø—Ä–∏ batch‚Äô–∞—Ö**|
|üßµ –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø|–ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ID|–ù–æ `SEQUENCE` —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ race condition –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –≤—Å—Ç–∞–≤–∫–∞—Ö|
|üîÑ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ|Hibernate –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –æ–±—ä–µ–∫—Ç –≤ `managed` —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–æ `flush()`|–í–µ—Ä—Å–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ|
## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `IDENTITY`

|–ü–æ–≤–µ–¥–µ–Ω–∏–µ|`SEQUENCE`|`IDENTITY`|
|---|---|---|
|ID –∏–∑–≤–µ—Å—Ç–µ–Ω –¥–æ –≤—Å—Ç–∞–≤–∫–∏|‚úÖ –î–∞|‚ùå –ù–µ—Ç|
|–ú–æ–∂–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å `INSERT` –¥–æ `flush()`|‚úÖ –î–∞|‚ùå –ù–µ—Ç (Hibernate –¥–µ–ª–∞–µ—Ç `INSERT` —Å—Ä–∞–∑—É)|
|–ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—É—â–Ω–æ—Å—Ç–µ–π –±–∞—Ç—á–µ–º|‚úÖ –î–∞|‚ùå –ù–µ—Ç|
|–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è `@Version` –ø—Ä–∏ batch-–≤—Å—Ç–∞–≤–∫–µ|‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ|‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω–æ –ø—Ä–∏ –∫–∞—Å–∫–∞–¥–∞—Ö|
|–†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–µ—Ä—Å–∏–∏|‚ùå –ù–µ—Ç|‚ö†Ô∏è –í–æ–∑–º–æ–∂–µ–Ω –ø—Ä–∏ —Ä–∞–Ω–Ω–µ–º `INSERT` –∏ `clear()`|
üëâ –¢–æ –µ—Å—Ç—å, **`SEQUENCE` –¥–µ–ª–∞–µ—Ç –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π**,  
–ø–æ—Ç–æ–º—É —á—Ç–æ Hibernate –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—ä–µ–∫—Ç–∞ (ID, –≤–µ—Ä—Å–∏—è, —Å–æ—Å—Ç–æ—è–Ω–∏–µ) **–¥–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –≤—Å—Ç–∞–≤–∫–∏**.
## üß† –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ
–ü—Ä–∏ `IDENTITY` Hibernate _–≤—ã–Ω—É–∂–¥–µ–Ω_ –¥–µ–ª–∞—Ç—å `INSERT` –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID).  
–ï—Å–ª–∏ –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞—Å–∫–∞–¥–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞, rollback, `flush` –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏),  
—Ç–æ Hibernate –º–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É `version` –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å—É—â–Ω–æ—Å—Ç–∏ –≤ persistence context.
–ü—Ä–∏ `SEQUENCE`, –Ω–∞–æ–±–æ—Ä–æ—Ç:
- Hibernate –∑–Ω–∞–µ—Ç ID –∑–∞—Ä–∞–Ω–µ–µ,
- –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç `INSERT` –¥–æ `flush()`,
- –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç `version = 0` –ª–æ–∫–∞–ª—å–Ω–æ,
- –∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ `flush()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π SQL ‚Äî –≤—Å—ë –≤ –æ–¥–Ω–æ–π —Ç–æ—á–∫–µ, —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ.
## üß© –í—ã–≤–æ–¥

|–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞|`SEQUENCE`|`IDENTITY`|
|---|---|---|
|ID –∏–∑–≤–µ—Å—Ç–µ–Ω –¥–æ –≤—Å—Ç–∞–≤–∫–∏|‚úÖ –î–∞|‚ùå –ù–µ—Ç|
|–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (`@Version`)|‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞|‚ö†Ô∏è –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –º–µ–Ω–µ–µ –≥–∏–±–∫–æ|
|Batch-–≤—Å—Ç–∞–≤–∫–∏ —Å `@Version`|‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ|‚ùå –ù–µ —Ä–∞–±–æ—Ç–∞—é—Ç|
|–†–∏—Å–∫ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è|‚ùå –ù–µ—Ç|‚ö†Ô∏è –ï—Å—Ç—å (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –∫–∞—Å–∫–∞–¥–∞—Ö)|
|–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|üöÄ –ë—ã—Å—Ç—Ä–µ–µ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –≤—Å—Ç–∞–≤–∫–∞—Ö|üê¢ –ú–µ–¥–ª–µ–Ω–Ω–µ–µ|
### ‚úÖ –ò—Ç–æ–≥:
- **–°—Ç—Ä–∞—Ç–µ–≥–∏—è `SEQUENCE` –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç —Å–∞–º –ø—Ä–∏–Ω—Ü–∏–ø –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**,  
    –Ω–æ **–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—É—é —Ä–∞–±–æ—Ç—É `@Version`**, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏:
    - –º–∞—Å—Å–æ–≤—ã—Ö –≤—Å—Ç–∞–≤–∫–∞—Ö (`batch insert`),
    - –∫–∞—Å–∫–∞–¥–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è—Ö (`@OneToMany`),
    - –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º `flush()`.