**CAP-теорема** — один из ключевых принципов, который нужно понимать при выборе типа хранилища данных, особенно в мире **NoSQL**.  
Она помогает объяснить, **какие компромиссы приходится делать** при проектировании и выборе распределённых систем хранения.
## 🧭 Что говорит CAP-теорема
CAP — это аббревиатура от:
- **C** — _Consistency_ (**согласованность**)
- **A** — _Availability_ (**доступность**)
- **P** — _Partition Tolerance_ (**устойчивость к разделению сети**)
📜 **Суть теоремы** (Эрик Брюер, 2000):
> В условиях сетевых разделений система может гарантировать **не более двух** из трёх свойств:  
> **C**, **A** или **P**.
## 📌 Подробно о каждом свойстве
### 🧮 1. Consistency — Согласованность
Все узлы системы в один и тот же момент времени видят **одни и те же данные**.  
После записи данные моментально становятся видны на всех узлах.
📌 Пример:  
Если пользователь обновил профиль, и тут же сделал повторный запрос — он получит обновлённые данные, независимо от того, к какому серверу попал.
👉 Обычно достигается через строгую синхронизацию между узлами.
### 🟢 2. Availability — Доступность
Каждый запрос к системе **получит ответ**, даже если некоторые узлы недоступны.  
Ответ может не гарантировать, что это последние данные, но система **не падает** и **не блокируется**.
📌 Пример:  
Если один сервер не отвечает, запрос обрабатывается другим. Пользователь всё равно получает данные (возможно, устаревшие).
### 🌐 3. Partition Tolerance — Устойчивость к разделению сети
Система продолжает работать, даже если связь между узлами нарушена (сеть «разбита» на сегменты).  
Это **неизбежное условие** для всех реально распределённых систем.
📌 Пример:  
Если часть дата-центра недоступна из-за обрыва связи, остальные узлы продолжают обрабатывать запросы.
👉 В современных распределённых системах **P не обсуждается — оно обязательно**.
## ⚖️ Компромисс CAP
Поскольку **P неизбежно**, разработчики фактически выбирают между:
- **CP** — Consistency + Partition tolerance (строгая согласованность, но могут быть задержки в доступности)
- **AP** — Availability + Partition tolerance (высокая доступность, но возможна временная несогласованность данных)
📌 **CA** (Consistency + Availability без Partition tolerance) возможно **только в централизованных системах**, не в распределённых.
## 🧭 Как это влияет на выбор NoSQL-хранилища
Разные NoSQL СУБД делают **разные акценты** по CAP:

|Тип NoSQL|Примеры|Модель CAP|Особенности|
|---|---|---|---|
|**CP**|HBase, MongoDB (в строгом режиме), Zookeeper|Consistency + Partition tolerance|Система гарантирует актуальность данных, но в случае разделения сети может временно потерять доступность|
|**AP**|Cassandra, Riak, DynamoDB|Availability + Partition tolerance|Система всегда отвечает, но может вернуть устаревшие данные (eventual consistency)|
|**CA**|Реляционные СУБД в одном узле|Consistency + Availability|Работает хорошо в нераспределённой среде, но неустойчива к сетевым сбоям|
## 🕰️ Eventual Consistency (в AP-системах)
Многие NoSQL-базы не поддерживают строгую согласованность, а используют **модель «в конечном итоге согласованности»**:
- После записи данные **распространяются по узлам с задержкой**;
- На короткое время разные пользователи могут видеть разные версии данных;
- Через некоторое время данные синхронизируются и становятся одинаковыми везде.
📌 Пример: в **Cassandra** обновление может занять несколько миллисекунд или секунд, но eventually все реплики будут одинаковыми.
## 🧠 Как выбирать модель в реальных проектах
### ✅ CP-системы
Подходят, если:
- ❗ Требуется строгая консистентность (банкинг, финансовые транзакции, бронирование).
- ⏳ Допустимо, что система временно не ответит при сбоях сети.
- Пример: онлайн-банкинг — нельзя показать старый баланс.
### ✅ AP-системы
Подходят, если:
- 🟢 Важна высокая доступность (сервис не должен падать при сбое узла).
- 🤝 Допустима временная рассогласованность данных.
- Пример: социальные сети — если пользователь не увидит сразу новый лайк, ничего критичного не произойдёт.
## ⚙️ Гибридные подходы (Tunable Consistency)
Современные системы (например, **Cassandra**, **MongoDB**) позволяют **настраивать уровень согласованности**:
- `ONE` — быстрее, но возможны устаревшие данные;
- `QUORUM` — баланс между доступностью и консистентностью;
- `ALL` — полная согласованность, но хуже доступность.
📌 Это даёт гибкость: разные операции могут использовать разные уровни гарантии.
## 🧾 Итог: что даёт CAP для выбора NoSQL

|Критерий|CP-система|AP-система|
|---|---|---|
|Согласованность данных|Строгая|В конечном итоге|
|Доступность|Может снижаться при сбоях сети|Гарантируется|
|Масштабируемость|Сложнее|Отличная|
|Примеры|MongoDB (strict), HBase|Cassandra, Riak, DynamoDB|
|Области применения|Банкинг, бронирование, финансы|Соцсети, логирование, мониторинг|
✅ **Ключевая мысль:**
> CAP-теорема не говорит, что одно свойство «лучше», а другое «хуже». Она помогает **осознанно выбирать компромисс**, который лучше подходит вашему сценарию.