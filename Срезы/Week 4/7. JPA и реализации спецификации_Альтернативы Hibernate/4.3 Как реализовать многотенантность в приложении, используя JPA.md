–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **–º–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (multi-tenancy)** –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Å **JPA / Hibernate** –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å **–Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ç–µ–Ω–∞–Ω—Ç–æ–≤)** —Å –∏–∑–æ–ª—è—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö. –í JPA/Hibernate —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **–ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é `MultiTenantConnectionProvider` –∏ `CurrentTenantIdentifierResolver`.
## üîπ 1. –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ Hibernate

|–°—Ç—Ä–∞—Ç–µ–≥–∏—è|–°—É—Ç—å|–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è|
|---|---|---|
|**SCHEMA**|–ö–∞–∂–¥—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ö–µ–º—É –≤ –æ–¥–Ω–æ–π –±–∞–∑–µ|`tenant1.users`, `tenant2.users`|
|**DATABASE**|–ö–∞–∂–¥—ã–π —Ç–µ–Ω–∞–Ω—Ç –∏–º–µ–µ—Ç —Å–≤–æ—é –æ—Ç–¥–µ–ª—å–Ω—É—é –±–∞–∑—É|`db_tenant1`, `db_tenant2`|
|**DISCRIMINATOR / COLUMN**|–í—Å–µ —Ç–µ–Ω–∞–Ω—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö, –Ω–æ —Å –∫–æ–ª–æ–Ω–∫–æ–π `tenant_id`|`users(tenant_id, id, name)`|
## üîπ 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Hibernate –¥–ª—è –º–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏
### üîπ –®–∞–≥ 1: –£–∫–∞–∑–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
```java
properties.put(Environment.MULTI_TENANT, MultiTenancyStrategy.SCHEMA);
```
### üîπ –®–∞–≥ 2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `CurrentTenantIdentifierResolver`
–≠—Ç–æ—Ç –∫–ª–∞—Å—Å —Å–æ–æ–±—â–∞–µ—Ç Hibernate, **–∫–∞–∫–æ–π —Ç–µ–Ω–∞–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**.
```java
public class CurrentTenantIdentifierResolverImpl implements CurrentTenantIdentifierResolver {

    @Override
    public String resolveCurrentTenantIdentifier() {
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –±–µ—Ä—ë–º tenantId –∏–∑ ThreadLocal, HTTP-–∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ JWT
        return TenantContext.getCurrentTenant();
    }

    @Override
    public boolean validateExistingCurrentSessions() {
        return true;
    }
}
```
### üîπ –®–∞–≥ 3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `MultiTenantConnectionProvider`
–≠—Ç–æ—Ç –∫–ª–∞—Å—Å —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏ —Å –±–∞–∑–æ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–æ–≤.
```java
public class DataSourceBasedMultiTenantConnectionProviderImpl implements MultiTenantConnectionProvider {

    private Map<String, DataSource> dataSources;

    @Override
    public Connection getConnection(String tenantIdentifier) throws SQLException {
        return dataSources.get(tenantIdentifier).getConnection();
    }

    @Override
    public Connection getAnyConnection() throws SQLException {
        return dataSources.values().iterator().next().getConnection();
    }

    // –î—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã (releaseConnection, supportsAggressiveRelease) —Ä–µ–∞–ª–∏–∑—É—é—Ç—Å—è –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É
}
```
### üîπ –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `EntityManagerFactory`
```java
@Bean
public LocalContainerEntityManagerFactoryBean entityManagerFactory(
        MultiTenantConnectionProvider connectionProvider,
        CurrentTenantIdentifierResolver tenantResolver) {

    LocalContainerEntityManagerFactoryBean emf = new LocalContainerEntityManagerFactoryBean();
    emf.setPackagesToScan("com.example.entity");
    emf.setJpaVendorAdapter(new HibernateJpaVendorAdapter());

    Map<String, Object> properties = new HashMap<>();
    properties.put(Environment.MULTI_TENANT, MultiTenancyStrategy.SCHEMA);
    properties.put(Environment.MULTI_TENANT_CONNECTION_PROVIDER, connectionProvider);
    properties.put(Environment.MULTI_TENANT_IDENTIFIER_RESOLVER, tenantResolver);

    emf.setJpaPropertyMap(properties);
    return emf;
}
```
## üîπ 3. –ü–æ–¥—Ö–æ–¥ —Å discriminator column (–∫–æ–ª–æ–Ω–∫–∞ tenant_id)
–ï—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—Ç—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ö–µ–º—ã –∏–ª–∏ –±–∞–∑—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É `tenant_id`:
```java
@Entity
@Table(name = "users")
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = "string"))
@Filters(@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId"))
public class User {
    @Id
    private Long id;
    private String name;
    private String tenantId;
}
```
–í —Å–µ—Ä–≤–∏—Å–µ –≤–∫–ª—é—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞:
```java
session.enableFilter("tenantFilter").setParameter("tenantId", tenantId);
```
> –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è SaaS-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –≥–¥–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ–Ω–∞–Ω—Ç–æ–≤ –∏–∑–æ–ª–∏—Ä—É—é—Ç—Å—è –ª–æ–≥–∏—á–µ—Å–∫–∏, –∞ –Ω–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏.
## üîπ 4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **SCHEMA / DATABASE**: –ª—É—á—à–µ –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤.
2. **DISCRIMINATOR / COLUMN**: –ø—Ä–æ—â–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö.
3. **TenantContext**: —É–¥–æ–±–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π `tenantId` –≤ `ThreadLocal` –∏–ª–∏ –≤ HTTP-—Å–µ—Å—Å–∏–∏.
4. **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –∫–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ–Ω–∞–Ω—Ç–∞.
5. **Spring Boot**: –Ω–∞—á–∏–Ω–∞—è —Å Hibernate 5+, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `LocalContainerEntityManagerFactoryBean`.