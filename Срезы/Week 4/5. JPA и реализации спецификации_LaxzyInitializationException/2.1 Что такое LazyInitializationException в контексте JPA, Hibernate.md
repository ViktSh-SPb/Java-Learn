## ‚öôÔ∏è –ß—Ç–æ —Ç–∞–∫–æ–µ `LazyInitializationException`
**`LazyInitializationException`** ‚Äî —ç—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç Hibernate,  
–∫–æ–≥–¥–∞ –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ **–ª–µ–Ω–∏–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–π (`LAZY`)** —Å—É—â–Ω–æ—Å—Ç–∏ –∏–ª–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏  
**–≤–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ (Session)**.
–ü—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è:
> –í—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –∫ —Å–≤—è–∑–∞–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `entity.getOrders()`),  
> –Ω–æ Hibernate —É–∂–µ **–∑–∞–∫—Ä—ã–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π**, –∏ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –º–æ–∂–µ—Ç.
## üîç –ü—Ä–∏–º–µ—Ä —Ç–∏–ø–∏—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
### ‚úÖ –ö–æ–¥ —Å—É—â–Ω–æ—Å—Ç–∏:
```java
@Entity
public class Author {
    @Id
    private Long id;

    private String name;

    @OneToMany(mappedBy = "author", fetch = FetchType.LAZY)
    private List<Book> books;
}
```
### ‚öôÔ∏è –ö–æ–¥ —Å–µ—Ä–≤–∏—Å–∞:
```java
@Transactional
public Author getAuthor(Long id) {
    return authorRepository.findById(id).orElseThrow();
}
```
### ‚ö†Ô∏è –ö–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:
```java
@GetMapping("/authors/{id}")
public AuthorDto getAuthor(@PathVariable Long id) {
    Author author = authorService.getAuthor(id);
    // –ó–¥–µ—Å—å Hibernate session —É–∂–µ –∑–∞–∫—Ä—ã—Ç–∞!
    return new AuthorDto(author.getName(), author.getBooks().size());
}
```
–†–µ–∑—É–ª—å—Ç–∞—Ç:
```
org.hibernate.LazyInitializationException:
failed to lazily initialize a collection of role:
com.example.Author.books, could not initialize proxy - no Session
```
## üìö –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
Hibernate –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –ª–µ–Ω–∏–≤—ã–µ —Å–≤—è–∑–∏ (`LAZY`) **—Ç–æ–ª—å–∫–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é** ‚Äî  
—Ç.–µ. –∫–æ–≥–¥–∞ –≤—ã –≤–ø–µ—Ä–≤—ã–µ –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –∫ `getBooks()`.
–ù–æ –∫–∞–∫ —Ç–æ–ª—å–∫–æ:
- –º–µ—Ç–æ–¥ —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π `@Transactional` –∑–∞–≤–µ—Ä—à–∏–ª—Å—è,
- Hibernate **–∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é (`Session.close()`)**,  
    –∏ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ –ë–î –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.
–ï—Å–ª–∏ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –∫ –ª–µ–Ω–∏–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ ‚Äî Hibernate –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL-–∑–∞–ø—Ä–æ—Å –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç `LazyInitializationException`.
## üß© –ú–µ—Ö–∞–Ω–∏–∫–∞ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
Hibernate –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å–æ–∑–¥–∞—ë—Ç **–ø—Ä–æ–∫—Å–∏-–æ–±—ä–µ–∫—Ç** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `PersistentBag`),  
–∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ `Session`.
–ü–æ–∫–∞ `Session` –∂–∏–≤–∞ ‚Äî –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Hibernate –≤—ã–ø–æ–ª–Ω—è–µ—Ç `SELECT ... WHERE author_id = ?`.
–ü–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è `Session` –ø—Ä–æ–∫—Å–∏ ¬´–æ—Å–∏—Ä–æ—Ç–µ–µ—Ç¬ª –∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –ª—é–±–æ–≥–æ –º–µ—Ç–æ–¥–∞ (`.size()`, `.iterator()`, `.get(0)`) –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, —Ç.–∫. –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.
## ‚úÖ –°–ø–æ—Å–æ–±—ã —Ä–µ—à–µ–Ω–∏—è

|–ü–æ–¥—Ö–æ–¥|–û–ø–∏—Å–∞–Ω–∏–µ|–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å|
|---|---|---|
|**1. –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é**|–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ LAZY-–ø–æ–ª—è–º –≤–Ω—É—Ç—Ä—å –º–µ—Ç–æ–¥–∞ —Å `@Transactional`.|–ö–æ–≥–¥–∞ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–±—É–µ—Ç —ç—Ç–∏—Ö –¥–∞–Ω–Ω—ã—Ö.|
|**2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JOIN FETCH`**|–Ø–≤–Ω–æ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ.|–ù–∞–∏–±–æ–ª–µ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ.|
|**3. –ò–∑–º–µ–Ω–∏—Ç—å `fetch = FetchType.EAGER`**|–í—Å–µ–≥–¥–∞ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.|–û—Å—Ç–æ—Ä–æ–∂–Ω–æ! –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–æ—á–Ω–æ –Ω—É–∂–Ω–æ –≤—Å–µ–≥–¥–∞.|
|**4. DTO –∏ –ø—Ä–æ–µ–∫—Ü–∏–∏**|–í—ã–±–∏—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `select new ...` –∏–ª–∏ Spring Data projection.|–õ—É—á—à–∏–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è REST / API.|
|**5. OpenSessionInView (OSIV)**|–î–µ—Ä–∂–∏—Ç Hibernate-—Å–µ—Å—Å–∏—é –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–æ –∫–æ–Ω—Ü–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–∞.|–ò–Ω–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω–∏–º–æ –≤ legacy –∏–ª–∏ read-heavy –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö.|
### üîπ 1. –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```java
@Transactional
public AuthorDto getAuthorWithBooks(Long id) {
    Author author = authorRepository.findById(id).orElseThrow();
    // –î–æ—Å—Ç—É–ø –∫ LAZY-–ø–æ–ª—è–º –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–µ–Ω
    author.getBooks().size();
    return mapper.toDto(author);
}
```
### üîπ 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JOIN FETCH`
```java
@Query("select a from Author a left join fetch a.books where a.id = :id")
Optional<Author> findByIdWithBooks(@Param("id") Long id);
```
‚Üí Hibernate –≤—ã–ø–æ–ª–Ω–∏—Ç **–æ–¥–∏–Ω SQL-–∑–∞–ø—Ä–æ—Å** —Å `JOIN`, –∏ –∫–æ–ª–ª–µ–∫—Ü–∏—è –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.
### üîπ 3. `EAGER` –∑–∞–≥—Ä—É–∑–∫–∞
```java
@OneToMany(mappedBy = "author", fetch = FetchType.EAGER)
private List<Book> books;
```
‚ö†Ô∏è –ù–æ: `EAGER` –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å **"N+1 problem"** –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –≤—ã–±–æ—Ä–∫–∞—Ö.  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–≤—è–∑—å –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–∞.
### üîπ 4. DTO-–ø—Ä–æ–µ–∫—Ü–∏–∏
```java
@Query("select new com.example.dto.AuthorDto(a.name, b.title) " +
       "from Author a left join a.books b where a.id = :id")
AuthorDto findAuthorInfo(@Param("id") Long id);
```
‚Üí –†–∞–±–æ—Ç–∞–µ—Ç **–±–µ–∑ –ª–µ–Ω–∏–≤—ã—Ö –ø—Ä–æ–∫—Å–∏**, –ø–æ—Ç–æ–º—É —á—Ç–æ Hibernate –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ä–∞–∑—É DTO —Å –≥–æ—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
### üîπ 5. Open Session in View (OSIV)
–í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑:
```properties
spring.jpa.open-in-view=true
```
‚Üí –¢–æ–≥–¥–∞ —Å–µ—Å—Å–∏—è Hibernate –æ—Å—Ç–∞—ë—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç–æ–π –¥–æ –∫–æ–Ω—Ü–∞ –∑–∞–ø—Ä–æ—Å–∞ (–≤ —Ç.—á. –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ).  
–ù–æ —ç—Ç–æ **–∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω** –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —Ç.–∫. –ª–æ–≥–∏–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Å–ª–æ—è —Å–µ—Ä–≤–∏—Å–∞.
## üí° –ö–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å –≤ —Ü–µ–ª–æ–º
‚úÖ –ü—Ä–∞–≤–∏–ª–æ:
> **–ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ª–µ–Ω–∏–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DTO / –º–∞–ø–ø–µ—Ä—ã –≤ —Å–µ—Ä–≤–∏—Å–Ω–æ–º —Å–ª–æ–µ.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JOIN FETCH` –∏–ª–∏ `EntityGraph`, –µ—Å–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ, –∫–∞–∫–∏–µ –ø–æ–ª—è –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è.
- –ù–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ OSIV –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ.
## üß† –ò—Ç–æ–≥–æ

|–ü—Ä–∏—á–∏–Ω–∞|–†–µ—à–µ–Ω–∏–µ|
|---|---|
|–°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞ –¥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ LAZY-–ø–æ–ª—è–º|–í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –Ω–∏–º –≤–Ω—É—Ç—Ä–∏ `@Transactional`|
|–ù—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ|–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `JOIN FETCH` –∏–ª–∏ DTO|
|–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ EAGER-–∑–∞–≥—Ä—É–∑–æ–∫|–õ–æ–∫–∞–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å `fetch` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö|
|–†–∞–±–æ—Ç–∞ —Å REST-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º–∏|–í–æ–∑–≤—Ä–∞—â–∞—Ç—å DTO, –Ω–µ —Å—É—â–Ω–æ—Å—Ç–∏|
