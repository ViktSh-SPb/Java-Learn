# üß† –ß—Ç–æ —Ç–∞–∫–æ–µ –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å
**Multi-tenancy** ‚Äî —ç—Ç–æ –ø–æ–¥—Ö–æ–¥, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º **–æ–¥–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ** –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç **–Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ (—Ç–µ–Ω–∞–Ω—Ç–æ–≤)**, –ø—Ä–∏ —ç—Ç–æ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑ –Ω–∏—Ö –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã.

|–£—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏|–ü—Ä–∏–º–µ—Ä|–°–ª–æ–∂–Ω–æ—Å—Ç—å|
|---|---|---|
|**Schema-based**|–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –≤ –æ–¥–Ω–æ–π –ë–î|‚öôÔ∏è —Å—Ä–µ–¥–Ω—è—è|
|**Database-based**|–æ—Ç–¥–µ–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö|üîê –≤—ã—Å–æ–∫–∞—è|
|**Discriminator-based (Table-based)**|–æ–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –Ω–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–æ–ª–æ–Ω–∫—É `tenant_id`|‚ö° –ø—Ä–æ—Å—Ç–∞—è|
# üß© –ü–æ–¥—Ö–æ–¥—ã –∫ –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ JPA (Hibernate)
Hibernate –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 3 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
```java
org.hibernate.MultiTenancyStrategy
```

|–°—Ç—Ä–∞—Ç–µ–≥–∏—è|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`DATABASE`|–æ—Ç–¥–µ–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞|
|`SCHEMA`|–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ (schema) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞|
|`DISCRIMINATOR`|–æ–±—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã, —Ä–∞–∑–ª–∏—á–∏–µ –ø–æ –∫–æ–ª–æ–Ω–∫–µ tenant_id|
## üß± 1. Discriminator-based (—á–µ—Ä–µ–∑ –∫–æ–ª–æ–Ω–∫—É tenant_id)
### üìã –ü—Ä–∏–º–µ—Ä —Å—É—â–Ω–æ—Å—Ç–∏:
```java
@Entity
@Table(name = "customers")
public class Customer {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    private String email;

    @Column(name = "tenant_id")
    private String tenantId;
}
```
üìå –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ `tenant_id`.
### ‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Hibernate Filter
```java
@Entity
@FilterDef(name = "tenantFilter", parameters = @ParamDef(name = "tenantId", type = String.class))
@Filters(@Filter(name = "tenantFilter", condition = "tenant_id = :tenantId"))
public class Customer {
    ...
}
```
–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:
```java
Session session = entityManager.unwrap(Session.class);
session.enableFilter("tenantFilter").setParameter("tenantId", currentTenantId);
```
üì¶ –£–¥–æ–±–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å **Spring interceptor** –∏–ª–∏ **Hibernate event listener**, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å `tenantId`.
## üóÇÔ∏è 2. Schema-based (–º—É–ª—å—Ç–∏-—Å—Ö–µ–º–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
–ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç (—Ç–µ–Ω–∞–Ω—Ç) –∏–º–µ–µ—Ç **—Å–≤–æ—é —Å—Ö–µ–º—É** –≤ –æ–¥–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:
```
db/
 ‚îú‚îÄ‚îÄ tenant_1.customers
 ‚îú‚îÄ‚îÄ tenant_2.customers
```
### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Hibernate
```yaml
spring:
  jpa:
    properties:
      hibernate.multiTenancy: SCHEMA
      hibernate.multi_tenant_connection_provider: com.example.config.SchemaConnectionProvider
      hibernate.tenant_identifier_resolver: com.example.config.CurrentTenantResolver
```
### üìò –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `MultiTenantConnectionProvider`
```java
@Component
public class SchemaConnectionProvider implements MultiTenantConnectionProvider {
    @Autowired
    private DataSource dataSource;

    @Override
    public Connection getConnection(String tenantIdentifier) throws SQLException {
        Connection connection = dataSource.getConnection();
        connection.setSchema(tenantIdentifier); // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å—Ö–µ–º—É
        return connection;
    }

    @Override
    public Connection getAnyConnection() throws SQLException {
        return dataSource.getConnection();
    }

    @Override
    public void releaseAnyConnection(Connection connection) throws SQLException {
        connection.close();
    }

    @Override
    public void releaseConnection(String tenantIdentifier, Connection connection) throws SQLException {
        connection.close();
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ default –∏–ª–∏ false
}
```
### üìò –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `CurrentTenantIdentifierResolver`
```java
@Component
public class CurrentTenantResolver implements CurrentTenantIdentifierResolver {
    @Override
    public String resolveCurrentTenantIdentifier() {
        return TenantContext.getCurrentTenant(); // –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ ThreadLocal
    }

    @Override
    public boolean validateExistingCurrentSessions() {
        return true;
    }
}
```
### üß© TenantContext (ThreadLocal)
```java
public class TenantContext {
    private static final ThreadLocal<String> TENANT = new ThreadLocal<>();

    public static void setCurrentTenant(String tenantId) {
        TENANT.set(tenantId);
    }

    public static String getCurrentTenant() {
        return TENANT.get();
    }

    public static void clear() {
        TENANT.remove();
    }
}
```
üìå –û–±—ã—á–Ω–æ `TenantContext` –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Spring `Filter` –∏–ª–∏ `Interceptor`, –∫–æ—Ç–æ—Ä—ã–π —Å—á–∏—Ç—ã–≤–∞–µ—Ç `X-Tenant-ID` –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ HTTP-–∑–∞–ø—Ä–æ—Å–∞.
## üßÆ 3. Database-based (–æ—Ç–¥–µ–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)
–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö SaaS-—Å–∏—Å—Ç–µ–º —Å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.
### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
```yaml
spring:
  jpa:
    properties:
      hibernate.multiTenancy: DATABASE
      hibernate.multi_tenant_connection_provider: com.example.config.DatabaseConnectionProvider
      hibernate.tenant_identifier_resolver: com.example.config.CurrentTenantResolver
```
### üìò –ü—Ä–∏–º–µ—Ä `MultiTenantConnectionProvider`
```java
@Component
public class DatabaseConnectionProvider implements MultiTenantConnectionProvider {
    private final Map<String, DataSource> dataSources = new HashMap<>();

    public DatabaseConnectionProvider() {
        // –º–æ–∂–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        dataSources.put("tenant1", createDataSource("jdbc:postgresql://localhost/tenant1"));
        dataSources.put("tenant2", createDataSource("jdbc:postgresql://localhost/tenant2"));
    }

    @Override
    public Connection getConnection(String tenantIdentifier) throws SQLException {
        return dataSources.get(tenantIdentifier).getConnection();
    }

    @Override
    public Connection getAnyConnection() throws SQLException {
        return dataSources.values().iterator().next().getConnection();
    }

    // –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ schema-based –ø—Ä–∏–º–µ—Ä—É
}
```
# ‚öñÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

|–ü–æ–¥—Ö–æ–¥|–ò–∑–æ–ª—è—Ü–∏—è|–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|–ù–∞—Å—Ç—Ä–æ–π–∫–∞|–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å|
|---|---|---|---|---|
|**DISCRIMINATOR (tenant_id)**|–ù–∏–∑–∫–∞—è|–í—ã—Å–æ–∫–∞—è|–ü—Ä–æ—Å—Ç–∞—è|–°—Ä–µ–¥–Ω—è—è|
|**SCHEMA**|–°—Ä–µ–¥–Ω—è—è|–°—Ä–µ–¥–Ω—è—è|–°—Ä–µ–¥–Ω—è—è|–•–æ—Ä–æ—à–∞—è|
|**DATABASE**|–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è|–ù–∏–∂–µ|–°–ª–æ–∂–Ω–∞—è|–û—Ç–ª–∏—á–Ω–∞—è|
# üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚úÖ **DISCRIMINATOR-based** ‚Äî –æ—Ç–ª–∏—á–Ω–æ –¥–ª—è –Ω–µ–±–æ–ª—å—à–∏—Ö SaaS, MVP, –≥–¥–µ –≤–∞–∂–Ω–∞ –ø—Ä–æ—Å—Ç–æ—Ç–∞.  
‚úÖ **SCHEMA-based** ‚Äî –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —Å–∫–æ—Ä–æ—Å—Ç—å—é.  
‚úÖ **DATABASE-based** ‚Äî –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Å –∫—Ä–∏—Ç–∏—á–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö.