# ACID
Принцип **ACID** описывает свойства транзакций. Расшифровывается так:
1. **Atomicity** (Атомарность)
2. **Consistency** (Согласованность)
3. **Isolation** (Изолированность)
4. **Durability** (Долговечность)
## Пример:
Когда вы переводите деньги с одного счета на другой, **ACID** гарантирует, что:
- Если списание прошло, а зачисление нет - транзакция отменится (атомарность).
- Сумма не потеряется и не появится "из воздуха" (согласованность).
- Другие операции не увидят промежуточного состояния (изолированность).
- После подтверждения перевод сохранится даже при отключении электричества (долговечность).
Эти принципы критичны для реляционных *СУБД* (*PostgreSQL, MySQL, Oracle* и т.д.), а в *NoSQL* они часто ослаблены в пользу производительности.
## 1. Atomicity (Атомарность)
**Определение:** Транзакция выполняется как единое целое: либо все ее операции применяются, либо ни одна. Если что-то пошло не так, происходит откат (rollback).
### Как это работает?
- Если в процессе транзакции происходит ошибка (например, разрыв соединения, сбой сервера), система откатывает (rollback) все изменения, сделанные до этого момента.
- Для этого СУБД используют журнал транзакций (transaction log), где фиксируются все шаги транзакции перед их фактическим применением к данным.
### Пример:
Допустим, есть транзакция перевода денег:
```sql
BEGIN TRANSACTION;
	UPDATE accounts SET balance = balance - 100 WHERE user_id = 1; -- Списание
	UPDATE accounts SET balance = balance + 100 WHERE user_id = 2; -- Зачисление
COMMIT;
```
Если после списания произойдет сбой, транзакция не будет зафиксирована и баланс пользователя 1 вернется к исходному значению.
### Техническая реализация:
- Двухфазный коммит (2PC) - механизм, гарантирующий, что все узлы в распределенной системе согласуют фиксацию или откат.
- Undo-логи - записи, позволяющие отменить изменения при сбое.
## 2. Consistency (Согласованность)
**Определение:** Транзакция переводит базу из одного корректного состояния в другое, соблюдая все правила и ограничения (например, уникальность ключей, целостность связей).
### Что это значит?
- В БД есть ограничения (`constraints`): первичные ключи (`PRIMARY KEY`), уникальность (`UNIQUE`), внешние ключи (`FOREIGN KEY`), проверки (`CHECK`).
- Если транзакция нарушает любое из этих правил, она откатывается целиком.
### Пример:
```sql
-- Ограничение: баланс не может быть отрицательным
ALTER TABLE accounts ADD CONSTRAINT positive_balance CHECK (balance >= 0);
-- Попытка списать больше, чем есть на счете
UPDATE accounts SET balance = balance - 200 WHERE user_id = 1;
-- ошибка CHECK-ограничения
```
Транзакция не выполнится, данные останутся в согласованном состоянии.
### Техническая реализация:
- Проверка ограничений перед фиксацией (или на каждом шаге, в зависимости от *СУБД*).
- В некоторых *СУБД* (например, *PostgreSQL*) можно отложить проверку (D`EFFERABLE CONSTRAINTS`).
## 3. Isolation (Изолированность)
**Определение:** Параллельные транзакции не должны влиять друг на друга. Например, одна транзакция не видит промежуточных данных другой (уровни изоляции бывают разными: *Read, Commited, Serializable*, и т.д.).
### Проблемы без изоляции (аномалии):
1. **"Грязное чтение" (Dirty read)** - транзакция видит незафиксированные изменения другой транзакции.
2. **"Неповторяемое чтение" (Non-repeatable read)** - при повторном чтении данные изменились.
3. **"Фантомное чтение" (Phantom read)** - появляются новые строки, которых раньше не было.
### Уровни изоляции (от слабых к сильным):

| Уровень          | Грязное чтение                       | Неповторяемое чтение                 | Фантомное чтение                     |
| ---------------- | ------------------------------------ | ------------------------------------ | ------------------------------------ |
| Read Uncommitted | <span style="color:green;">ДА</span> | <span style="color:green;">ДА</span> | <span style="color:green;">ДА</span> |
| Read Committed   | <span style="color:red;">НЕТ</span>  | <span style="color:green;">ДА</span> | <span style="color:green;">ДА</span> |
| Repeatable Read  | <span style="color:red;">НЕТ</span>  | <span style="color:red;">НЕТ</span>  | <span style="color:green;">ДА</span> |
| Serializable     | <span style="color:red;">НЕТ</span>  | <span style="color:red;">НЕТ</span>  | <span style="color:red;">НЕТ</span>  |
|                  |                                      |                                      |                                      |
### Пример:
```sql
-- Транзакция 1 (изменяет данные)
BEGIN;
	UPDATE acounts SET balance = 200 WHERE user_id = 1;
-- Транзакция 2 (читает данные)
BEGIN;
	SELECT balance FROM accounts WHERE user_id = 1;
-- Может увидеть 200 (если Read Uncommitted) или старые данные (если Read Committed)
```
### Техническая реализация:
- **Блокировки (locks)**:
	- `SELECT FOR UPDATE` - блокирует строки для изменения.
	- `SHARE MODE` - блокирует строки для чтения.
- **Многоверсионность (MVCC)**:
	- *PostgreSQL, Oracle* хранят несколько версий строк, чтобы читатели не блокировали писателей
## 4. Durability (Долговечность)
**Определение:** После успешного `COMMIT` изменения сохраняются навсегда, даже при сбое (например, благодаря записи в журнал транзакций).
### Как это работает?
1. СУБД сначала записывает изменения в журнал транзакций (*WAL - Write-Ahead Log*).
2. Только после этого данные обновляются в основной памяти (буфере).
3. Даже если сервер упадет после `COMMIT`, при перезапуске СУБД восстановит изменения из журнала.
### Техническая реализация:
- Синхронная запись на диск (*fsync*).
- Репликация (если данные скопированы на другой сервер, они переживут сбой основного).