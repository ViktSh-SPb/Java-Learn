# üß† –û—Å–Ω–æ–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ SQL –≤ JPA

|–ü–æ–¥—Ö–æ–¥|–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞|–ì–¥–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è|–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å|
|---|---|---|---|
|**JPQL / HQL**|–û–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —è–∑—ã–∫|–ß–µ—Ä–µ–∑ `@Query` –∏–ª–∏ `EntityManager`|–ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤|
|**Native SQL**|–ß–∏—Å—Ç—ã–π SQL|–ß–µ—Ä–µ–∑ `@Query(nativeQuery = true)` –∏–ª–∏ `createNativeQuery()`|–ü—Ä–∏ —Å–ª–æ–∂–Ω—ã—Ö SQL-–∑–∞–ø—Ä–æ—Å–∞—Ö|
|**Named Queries**|JPQL –∏–ª–∏ SQL|–í –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö –∏–ª–∏ `orm.xml`|–î–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤|
|**Criteria API**|–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤|–ß–µ—Ä–µ–∑ `CriteriaBuilder`|–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π|
|**Stored Procedures**|SQL-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏–∑ –ë–î|–ß–µ—Ä–µ–∑ `@NamedStoredProcedureQuery`|–ö–æ–≥–¥–∞ –ª–æ–≥–∏–∫–∞ –≤ –ë–î|
## üß© 1. JPQL (Java Persistence Query Language)
–≠—Ç–æ –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —è–∑—ã–∫ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ SQL,  
–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å **—Å—É—â–Ω–æ—Å—Ç—è–º–∏ –∏ –∏—Ö –ø–æ–ª—è–º–∏**, –∞ –Ω–µ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ –∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏.
```java
@Query("SELECT a FROM Author a WHERE a.name = :name")
List<Author> findByName(@Param("name") String name);
```
üîπ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Å `@Query`** –≤ Spring Data JPA –∏–ª–∏ —á–µ—Ä–µ–∑ `EntityManager.createQuery()`.
## üß± 2. Native SQL (—á–∏—Å—Ç—ã–π SQL)
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å **–Ω–∞—Å—Ç–æ—è—â–∏–π SQL**, JPA —ç—Ç–æ —Ç–æ–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç.
### üìç –í Spring Data JPA
```java
@Query(value = "SELECT * FROM authors WHERE country = :country", nativeQuery = true)
List<Author> findAuthorsByCountry(@Param("country") String country);
```
### üìç –ß–µ—Ä–µ–∑ `EntityManager`
```java
List<Object[]> results = entityManager
    .createNativeQuery("SELECT id, name FROM authors WHERE country = ?")
    .setParameter(1, "France")
    .getResultList();
```
üî∏ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏–±–æ `Object[]`, –ª–∏–±–æ —Å—É—â–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ —É–∫–∞–∑–∞—Ç—å –∫–ª–∞—Å—Å:
```java
List<Author> authors = entityManager
    .createNativeQuery("SELECT * FROM authors WHERE country = :country", Author.class)
    .setParameter("country", "France")
    .getResultList();
```
## üßæ 3. –ú–∞–ø–ø–∏–Ω–≥ SQL-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ DTO (—á–µ—Ä–µ–∑ `@SqlResultSetMapping`)
–ö–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å **–Ω–µ —Å—É—â–Ω–æ—Å—Ç—å**, –∞ –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—ä–µ–∫—Ç.
```java
@SqlResultSetMapping(
    name = "AuthorSummaryMapping",
    classes = @ConstructorResult(
        targetClass = AuthorSummary.class,
        columns = {
            @ColumnResult(name = "name", type = String.class),
            @ColumnResult(name = "book_count", type = Long.class)
        }
    )
)
@NamedNativeQuery(
    name = "Author.findAuthorSummaries",
    query = """
        SELECT a.name, COUNT(b.id) AS book_count
        FROM authors a
        LEFT JOIN books b ON a.id = b.author_id
        GROUP BY a.name
    """,
    resultSetMapping = "AuthorSummaryMapping"
)
@Entity
public class Author {
    @Id
    private Long id;
    private String name;
}
```
```java
public record AuthorSummary(String name, Long bookCount) {}
```
–í—ã–∑–æ–≤:
```java
List<AuthorSummary> list =
    entityManager.createNamedQuery("Author.findAuthorSummaries", AuthorSummary.class)
    .getResultList();
```
## üßÆ 4. Criteria API ‚Äî —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ª–æ–≤–∏–π, –∑–∞–¥–∞–≤–∞–µ–º—ã—Ö –≤ –∫–æ–¥–µ.
```java
CriteriaBuilder cb = entityManager.getCriteriaBuilder();
CriteriaQuery<Author> query = cb.createQuery(Author.class);
Root<Author> root = query.from(Author.class);

Predicate countryFilter = cb.equal(root.get("country"), "USA");
query.select(root).where(countryFilter);

List<Author> authors = entityManager.createQuery(query).getResultList();
```
‚úÖ –ü–ª—é—Å—ã:
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ
- –£–¥–æ–±–Ω–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
‚ùå –ú–∏–Ω—É—Å—ã:
- –ö–æ–¥ –≥—Ä–æ–º–æ–∑–¥–∫–∏–π
## ‚öôÔ∏è 5. –•—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã (Stored Procedures)
–ï—Å–ª–∏ —á–∞—Å—Ç—å –ª–æ–≥–∏–∫–∏ –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:
```java
@NamedStoredProcedureQuery(
    name = "Author.countBooks",
    procedureName = "count_books_by_author",
    parameters = {
        @StoredProcedureParameter(mode = ParameterMode.IN, name = "author_id", type = Long.class),
        @StoredProcedureParameter(mode = ParameterMode.OUT, name = "book_count", type = Integer.class)
    }
)
@Entity
public class Author {
    @Id
    private Long id;
    private String name;
}
```
–í—ã–∑–æ–≤:
```java
StoredProcedureQuery query = entityManager
    .createNamedStoredProcedureQuery("Author.countBooks")
    .setParameter("author_id", 1L);

query.execute();
Integer count = (Integer) query.getOutputParameterValue("book_count");
```
## ‚ö° 6. –ü—Ä–∏–º–µ—Ä –¥–ª—è Spring Data JPA —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º SQL –∏ DTO
```java
public interface AuthorRepository extends JpaRepository<Author, Long> {
    @Query(value = """
        SELECT a.name AS name, COUNT(b.id) AS bookCount
        FROM authors a
        LEFT JOIN books b ON a.id = b.author_id
        GROUP BY a.name
    """, nativeQuery = true)
    List<AuthorSummaryProjection> findAuthorSummaries();
}

public interface AuthorSummaryProjection {
    String getName();
    Long getBookCount();
}
```
üìã –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Spring Projection**, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞.
## üß† –ò—Ç–æ–≥–æ

|–ü–æ–¥—Ö–æ–¥|–ì–¥–µ –ø–∏—à–µ—Ç—Å—è|–¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞|–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞|
|---|---|---|---|
|**JPQL**|JPA / Spring `@Query`|–û–±—ä–µ–∫—Ç–Ω—ã–π|–ë–µ–∑–æ–ø–∞—Å–µ–Ω, –ø–µ—Ä–µ–Ω–æ—Å–∏–º|
|**Native SQL**|`@Query(nativeQuery = true)`|SQL|–ü–æ–ª–Ω–∞—è –≥–∏–±–∫–æ—Å—Ç—å|
|**Named Queries**|–í –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è—Ö|JPQL / SQL|–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å|
|**Criteria API**|–í –∫–æ–¥–µ|–û–±—ä–µ–∫—Ç–Ω—ã–π|–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã|
|**Stored Procedures**|–í –ë–î|SQL|–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏|
