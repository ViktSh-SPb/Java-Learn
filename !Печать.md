Команда `docker build` используется для **сборки Docker-образа** из Dockerfile. Она читает инструкции из файла (по умолчанию `Dockerfile`) и создает новый образ, который можно запускать как контейнер.  

---

## **Синтаксис**  
```bash
docker build [ОПЦИИ] ПУТЬ_ИЛИ_URL
```

### **Основные опции**  
| Опция                | Описание                                                                 |
|----------------------|--------------------------------------------------------------------------|
| `-t, --tag`          | Задает имя и тег образа (например, `-t myapp:1.0`).                      |
| `-f, --file`         | Указывает путь к Dockerfile (если он не в текущей папке).                |
| `--build-arg`        | Передает переменные для `ARG` в Dockerfile.                              |
| `--no-cache`         | Игнорирует кэш слоев (полная пересборка).                               |
| `--pull`             | Всегда скачивать актуальную версию базового образа (`FROM`).             |
| `--target`           | Собирает только определенную стадию в многоступенчатой сборке.          |
| `--platform`         | Указывает платформу (например, `linux/amd64`, `linux/arm64`).           |

---

## **Примеры использования**  

### 1. **Сборка образа с тегом**  
```bash
docker build -t myapp:latest .
```
- `-t myapp:latest` — имя и тег образа.  
- `.` — путь к папке с Dockerfile.  

---

### 2. **Указание другого Dockerfile**  
Если файл называется не `Dockerfile` или лежит в другой папке:  
```bash
docker build -t myapp -f ./docker/prod.Dockerfile .
```

---

### 3. **Передача переменных (`ARG`)**  
Если в Dockerfile есть `ARG`:  
```dockerfile
# Dockerfile
ARG VERSION=latest
FROM alpine:$VERSION
```
Можно переопределить при сборке:  
```bash
docker build --build-arg VERSION=3.18 -t myalpine .
```

---

### 4. **Многоступенчатая сборка (`--target`)**  
```dockerfile
# Dockerfile
FROM node:20 AS builder
WORKDIR /app
COPY . .
RUN npm install && npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```
Собрать только стадию `builder`:  
```bash
docker build --target builder -t myapp-builder .
```

---

### 5. **Сборка для другой платформы**  
```bash
docker build --platform linux/arm64 -t myapp-arm64 .
```

---

## **Как работает сборка?**  
1. Docker читает `Dockerfile` и выполняет инструкции **последовательно**.  
2. Каждая команда (`RUN`, `COPY` и др.) создает новый **слой образа**.  
3. Слои кэшируются — если инструкции не менялись, Docker использует кэш.  
4. В конце создается финальный образ с указанным тегом.  

---

## **Оптимизация сборки**  
### 1. **Используйте `.dockerignore`**  
Чтобы исключить ненужные файлы (например, `node_modules`, `.git`):  
```text
# .dockerignore
**/node_modules
.git
*.log
```

### 2. **Минимизируйте количество слоев**  
Объединяйте команды `RUN`:  
```dockerfile
RUN apt-get update && \
    apt-get install -y curl && \
    rm -rf /var/lib/apt/lists/*
```

### 3. **Многоступенчатые сборки**  
Уменьшают размер финального образа:  
```dockerfile
FROM node:20 AS builder
# Сборка приложения

FROM alpine:latest
COPY --from=builder /app/dist /usr/share/nginx/html
```

---

## **Просмотр истории сборки**  
Чтобы увидеть слои образа:  
```bash
docker history myapp:latest
```

---

## **Частые ошибки**  
1. **`COPY failed: file not found`**  
   - Проверьте пути в `COPY` и `.dockerignore`.  
2. **Кэш не обновляется**  
   - Используйте `--no-cache`:  
     ```bash
     docker build --no-cache -t myapp .
     ```  
3. **Нет доступа к файлам**  
   - Убедитесь, что у пользователя есть права на чтение.  

---

## **Вывод**  
- `docker build` — основная команда для создания образов.  
- Используйте `-t` для именования, `-f` для кастомных Dockerfile.  
- Оптимизируйте сборку через кэш, `.dockerignore` и многоступенчатость.  
- Для кросс-платформенной сборки указывайте `--platform`.  

Пример итоговой команды:  
```bash
docker build -t myapp:1.0 --build-arg ENV=prod -f ./Dockerfile.prod .
```
