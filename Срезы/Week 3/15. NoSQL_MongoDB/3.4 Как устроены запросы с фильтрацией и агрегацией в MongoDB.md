## 1Ô∏è‚É£ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (Query / find)**
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ‚Äî —ç—Ç–æ –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º. MongoDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ç–æ–¥ `.find()` –∏ –æ–±—ä–µ–∫—Ç **Query** (–∏–ª–∏ BSON) –¥–ª—è —É—Å–ª–æ–≤–∏–π.
### üîπ –ü—Ä–∏–º–µ—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤
**Mongo Shell:**
```javascript
db.users.find({ age: 30 }) // –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å age = 30

db.users.find({ age: { $gt: 25 } }) // –≤—Å–µ, —É –∫–æ–≥–æ age > 25

db.users.find({ name: { $in: ["Alice", "Bob"] } }) // name = Alice –∏–ª–∏ Bob

db.users.find({ email: { $regex: /@example\.com$/ } }) // email –æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ @example.com
```
**Spring Data MongoDB ‚Äî —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:**
```java
List<User> users = userRepository.findByAgeGreaterThan(25);

User user = userRepository.findByName("Alice");
```
**Spring Data MongoDB ‚Äî —á–µ—Ä–µ–∑ `MongoTemplate`:**
```java
Query query = new Query();
query.addCriteria(Criteria.where("age").gt(25));
List<User> users = mongoTemplate.find(query, User.class);
```
### üîπ –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

|–û–ø–µ—Ä–∞—Ç–æ—Ä|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`$eq`|—Ä–∞–≤–Ω–æ|
|`$ne`|–Ω–µ —Ä–∞–≤–Ω–æ|
|`$gt`|–±–æ–ª—å—à–µ|
|`$gte`|–±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ|
|`$lt`|–º–µ–Ω—å—à–µ|
|`$lte`|–º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ|
|`$in`|–≤ —Å–ø–∏—Å–∫–µ –∑–Ω–∞—á–µ–Ω–∏–π|
|`$nin`|–Ω–µ –≤ —Å–ø–∏—Å–∫–µ|
|`$regex`|–ø–æ–∏—Å–∫ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é|
|`$exists`|–ø–æ–ª–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç|
|`$and/$or`|–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏|
## 2Ô∏è‚É£ **–ê–≥—Ä–µ–≥–∞—Ü–∏—è (Aggregation)**
–ê–≥—Ä–µ–≥–∞—Ü–∏—è ‚Äî —ç—Ç–æ **–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- –í MongoDB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **aggregation pipeline** ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞–¥–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`$match`, `$group`, `$sort`, `$project`, `$limit`, `$unwind`).
### üîπ –ü—Ä–∏–º–µ—Ä: –ø–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
**Mongo Shell:**
```javascript
db.users.aggregate([
    { $match: { age: { $gte: 18 } } }, // —Ñ–∏–ª—å—Ç—Ä
    { $group: { _id: "$age", count: { $sum: 1 } } }, // –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
    { $sort: { count: -1 } } // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
])
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{ "_id": 25, "count": 10 }
{ "_id": 30, "count": 7 }
```
### üîπ –ü—Ä–∏–º–µ—Ä: –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞
```javascript
db.users.aggregate([
    { $group: { _id: null, avgAge: { $avg: "$age" } } }
])
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{ "_id": null, "avgAge": 28.5 }
```
### üîπ –ü—Ä–∏–º–µ—Ä: —Å —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º –º–∞—Å—Å–∏–≤–æ–≤ (`$unwind`)
```javascript
db.users.aggregate([
    { $unwind: "$tags" },
    { $group: { _id: "$tags", count: { $sum: 1 } } },
    { $sort: { count: -1 } }
])
```
> –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ç–µ–≥ –≤ –º–∞—Å—Å–∏–≤–µ `tags`.
### üîπ –í Spring Data MongoDB —Å `MongoTemplate`
```java
Aggregation agg = Aggregation.newAggregation(
    Aggregation.match(Criteria.where("age").gte(18)),
    Aggregation.group("age").count().as("count"),
    Aggregation.sort(Sort.by(Sort.Direction.DESC, "count"))
);

AggregationResults<Document> results = mongoTemplate.aggregate(agg, "users", Document.class);
results.forEach(d -> System.out.println(d.toJson()));
```
‚úÖ `Aggregation` API –≤ Spring Data –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å pipeline –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ, –∫–∞–∫ –≤ Mongo Shell.
## 3Ô∏è‚É£ **–°—Ç–∞–¥–∏–∏ pipeline –≤ MongoDB**

|–°—Ç–∞–¥–∏—è|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`$match`|–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤|
|`$group`|–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–ª—é—á—É, –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤|
|`$project`|–í—ã–±–æ—Ä –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π|
|`$sort`|–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞|
|`$limit`|–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤|
|`$skip`|–ü—Ä–æ–ø—É—Å–∫ –ø–µ—Ä–≤—ã—Ö N –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤|
|`$unwind`|–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤|
|`$lookup`|Join —Å –¥—Ä—É–≥–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π|
|`$count`|–ü–æ–¥—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤|
|`$addFields`|–î–æ–±–∞–≤–ª–µ–Ω–∏–µ/–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π|
### üîπ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- `find()` –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤.
- `aggregate()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–ø–æ–¥—Å—á—ë—Ç–∞, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–π –∏ —Å–ª–æ–∂–Ω—ã—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π**.
- –ò–Ω–¥–µ–∫—Å—ã –ø–æ–º–æ–≥–∞—é—Ç —É—Å–∫–æ—Ä—è—Ç—å `$match` –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç–∞–¥–∏–∏ pipeline.
- –ú–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—é: —Å–Ω–∞—á–∞–ª–∞ `$match`, –∑–∞—Ç–µ–º `$group` –∏ `$sort`

‚úÖ **–ò—Ç–æ–≥**
1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** (`find`, `Query`, `Criteria`) ‚Äî –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
2. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è** (`aggregate`, `Aggregation`) ‚Äî –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫, –ø–æ–¥—Å—á—ë—Ç–æ–≤, –≤—ã—á–∏—Å–ª–µ–Ω–∏–π, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π.
3. **Pipeline** = –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞–¥–∏–π: `$match` ‚Üí `$group` ‚Üí `$sort` ‚Üí `$project`.
4. –ò–Ω–¥–µ–∫—Å—ã —É—Å–∫–æ—Ä—è—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ `$match` –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.