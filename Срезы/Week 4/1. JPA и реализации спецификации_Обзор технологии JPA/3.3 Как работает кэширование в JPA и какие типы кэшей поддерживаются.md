# üß† –ß—Ç–æ —Ç–∞–∫–æ–µ –∫—ç—à –≤ JPA
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JPA ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö **–Ω–µ —Ö–æ–¥–∏—Ç—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**.
–í JPA –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ **–¥–≤–∞ —É—Ä–æ–≤–Ω—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**:
1. **–ü–µ—Ä–≤–∏—á–Ω—ã–π –∫—ç—à (First-Level Cache)** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω –≤ `EntityManager`
2. **–í—Ç–æ—Ä–∏—á–Ω—ã–π –∫—ç—à (Second-Level Cache)** ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π, –Ω–∞ —É—Ä–æ–≤–Ω–µ persistence unit
## ü•á 1. –ü–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ (First-Level Cache)
### üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –û–Ω **–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**.
- –†–∞–±–æ—Ç–∞–µ—Ç **–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ `EntityManager`** (–∏–ª–∏ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Spring Data JPA).
- –ï—Å–ª–∏ –≤—ã –≤—ã–∑—ã–≤–∞–µ—Ç–µ `find()` –∏–ª–∏ `getReference()` –¥–ª—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏, JPA –≤–µ—Ä–Ω—ë—Ç **—Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç –∏–∑ –∫—ç—à–∞**, –Ω–µ –æ–±—Ä–∞—â–∞—è—Å—å –∫ –ë–î.
### üîß –ü—Ä–∏–º–µ—Ä:
```java
EntityManager em = entityManagerFactory.createEntityManager();
em.getTransaction().begin();

Author author1 = em.find(Author.class, 1L); // SQL –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
Author author2 = em.find(Author.class, 1L); // SQL –ù–ï –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–∫—ç—à!)

System.out.println(author1 == author2); // true ‚Äî —Ç–æ—Ç –∂–µ –æ–±—ä–µ–∫—Ç

em.getTransaction().commit();
em.close(); // –∫—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è
```
### üìå –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –ö—ç—à –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ `em.clear()` –∏–ª–∏ `em.close()`.
- –û–Ω **–Ω–µ —Ä–∞–∑–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏**.
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤ —Ä–∞–º–∫–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
## ü•à 2. –í—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å –∫—ç—à–∞ (Second-Level Cache)
### üìã –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ù–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.
- –†–∞–±–æ—Ç–∞–µ—Ç **–Ω–∞ —É—Ä–æ–≤–Ω–µ `EntityManagerFactory`** ‚Äî –æ–±—â–∏–π –¥–ª—è –≤—Å–µ—Ö `EntityManager`.
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—É—â–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏, —Å–Ω–∏–∂–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –ë–î.
- –¢—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –∫—ç—à–∏—Ä—É—é—â–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
### üß∞ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã:
- **Ehcache**
- **Infinispan**
- **Hazelcast**
- **Caffeine**
- **Redis** (—á–µ—Ä–µ–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∞–¥–∞–ø—Ç–µ—Ä—ã)
## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è –∫—ç—à–∞ (–ø—Ä–∏–º–µ—Ä —Å Hibernate + Ehcache)
### `persistence.xml` –∏–ª–∏ `application.yml`
```yaml
spring:
  jpa:
    properties:
      hibernate.cache.use_second_level_cache: true
      hibernate.cache.region.factory_class: org.hibernate.cache.ehcache.EhCacheRegionFactory
      hibernate.cache.use_query_cache: true
```
### –í —Å—É—â–Ω–æ—Å—Ç–∏:
```java
@Entity
@Cacheable
@org.hibernate.annotations.Cache(usage = CacheConcurrencyStrategy.READ_WRITE)
public class Author {
    @Id
    private Long id;
    private String name;
}
```
## üß± 3. –ö—ç—à –∑–∞–ø—Ä–æ—Å–æ–≤ (Query Cache)
- –•—Ä–∞–Ω–∏—Ç **—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã HQL / JPQL-–∑–∞–ø—Ä–æ—Å–æ–≤**.
- –†–∞–±–æ—Ç–∞–µ—Ç **–ø–æ–≤–µ—Ä—Ö –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è –∫—ç—à–∞**.
- –ù—É–∂–Ω–æ —è–≤–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.
### –ü—Ä–∏–º–µ—Ä:
```java
List<Author> authors = entityManager.createQuery("FROM Author", Author.class)
    .setHint("org.hibernate.cacheable", true)
    .getResultList();
```
## üß© –¢–∏–ø—ã –∫—ç—à–µ–π –∏ –∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏

|–°—Ç—Ä–∞—Ç–µ–≥–∏—è|–û–ø–∏—Å–∞–Ω–∏–µ|–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ|
|---|---|---|
|`READ_ONLY`|–¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ, –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω—è—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏|–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏, –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ|
|`NONSTRICT_READ_WRITE`|–ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã "–≥—Ä—è–∑–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ|–î–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è –Ω–µ—á–∞—Å—Ç–æ –º–µ–Ω—è—é—â–∏—Ö—Å—è —Å—É—â–Ω–æ—Å—Ç–µ–π|
|`READ_WRITE`|–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ –∑–∞–ø–∏—Å—å|–û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–∑–Ω–µ—Å-–¥–∞–Ω–Ω—ã–µ|
|`TRANSACTIONAL`|–ü–æ–ª–Ω–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Å JTA)|–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ|
## üßπ 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º –≤—Ä—É—á–Ω—É—é
```java
Cache cache = entityManagerFactory.getCache();

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Å—É—â–Ω–æ—Å—Ç—å –≤ –∫—ç—à–µ
boolean isCached = cache.contains(Author.class, 1L);

// –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—É—â–Ω–æ—Å—Ç—å
cache.evict(Author.class, 1L);

// –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à —Ü–µ–ª–∏–∫–æ–º
cache.evictAll();
```
## üß† –ò—Ç–æ–≥–æ

|–£—Ä–æ–≤–µ–Ω—å|–û–±–ª–∞—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—è|–ü—Ä–æ–≤–∞–π–¥–µ—Ä|–ù–∞—Å—Ç—Ä–æ–π–∫–∞|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|
|---|---|---|---|---|
|**1-–π —É—Ä–æ–≤–µ–Ω—å**|EntityManager (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)|–í—Å—Ç—Ä–æ–µ–Ω|–ù–µ —Ç—Ä–µ–±—É–µ—Ç|–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å|
|**2-–π —É—Ä–æ–≤–µ–Ω—å**|EntityManagerFactory|Ehcache, Infinispan –∏ –¥—Ä.|–¢—Ä–µ–±—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏|–ü–æ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|
|**Query Cache**|–†–µ–∑—É–ª—å—Ç–∞—Ç—ã JPQL-–∑–∞–ø—Ä–æ—Å–æ–≤|Hibernate Cache|–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ü–∏—è|–ë—ã—Å—Ç—Ä—ã–π –ø–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤|
