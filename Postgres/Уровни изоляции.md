# Уровни изоляции
## Что такое уровень изоляции?
В многопользовательских базах данных часто происходит одновременный доступ к данным: одни транзакции читают данные, другие - изменяют. Чтобы предотвратить ошибки, потери данных или неконсистентность, нужны механизмы изоляции транзакций.

Уровни изоляции определяют, какие изменения, сделанные одной транзакцией, могут быть видны другим транзакциям до их завершения (`COMMIT/ROLLBACK`).
## Проблемы конкурентного доступа
Прежде чем описывать уровни изоляции, нужно понять три основных аномалии (ошибки), которые могут возникать:

| Аномалия                                       | Описание                                                                                                                     |
| ---------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **Грязное чтение (dirty read)**                | Транзакция читает данные, которые были изменены, но еще не зафиксированы другой транзакцией. Эти данные могут быть отменены. |
| **Неповторяемое чтение (non-repeatable read)** | Повторное чтение одной и той же строки в рамках одной транзакции дает разные результаты, т.к. другая транзакция ее изменила. |
| **Фантомное чтение (phantom read)**            | Повторное выполнение запроса с одним и тем же условием возвращает новые строки, добавленные другой транзакцией               |
## Уровни изоляции по ANSI SQL
### 1.Read Uncommited
**Read uncommited** - чтение неподтвержденных данных.
- **Разрешает:** грязные, неповторяемые и фантомные чтения.
- **Пример:**
	- `T1 обновляет баланс = 5000 -> 0, но не коммитит.`
	- `Т2 читает баланс = 0, хотя Т1 может сделать rollback.`
- **Использование:** почти никогда в ответственных системах.
- **Преимущества:** максимальная производительность.
- **Недостатки:** никакой надежности.
### 2. Read Committed
**Read committed** - чтение подтвержденных данных.
- **Запрещает:** грязное чтение.
- **Разрешает:** неповторяемое и фантомное чтение.
- **Пример:**
	- `Т1 читает строку А -> видит  х = 100`
	- `Т2 изменяет х = 200, коммитит`
	- `Т1 снова читает строку А -> видит х = 200`
- **Особенность:** используется по умолчанию в *Oracle, PostgreSQL, SQL Server*.
- **Компромисс:** безопаснее, чем **Read Uncommited**, но не идеально.
### 3. Repeatable Read
**Repeatable read** - повторяемое чтение.
- **Запрещает:** грязное и неповторяемое чтение.
- **Разрешает:** фантомное чтение.
- **Пример:**
	- `Т1 читает строку А -> x = 100`
	- `Т2 пытается изменить А -> блокируется до конца Т1`
	- `Но если Т2 вставить новую строку, которая тоже подходит под WHERE T1 - она может всплыть при повторном запросе.`
- **Используется в:** *MySQL (InnoDB)* как уровень по умолчанию.
- **Промежуточный вариант:** дает хорошую согласованность без жесткой сериализации.
### 4. Serializable
**Serializable** - полная сериализация.
- **Запрещает:** все три аномалии.
- **Имитация:** транзакции исполняются строго по очереди.
- **Механизм реализации:**
	- Либо блокировки на диапазоны значений (*range locks*)
	- Либо проверка конфликтов (в *PostgreSQL - MVCC* с сериализуемым контролем).
- **Плюсы:** максимальная надежность.
- **Минусы:** самая медленная, часто приводит к блокировкам или откатам транзакций.
## Как задать уровень изоляции?
*PostgreSQL/MySQL:*
```sql
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
-- SQL-запросы...
COMMIT;
```
## Особенности разных СУБД

| СУБД               | Уровень по умолчанию            | Примечания                                      |
| ------------------ | ------------------------------- | ----------------------------------------------- |
| **PostgreSQL**     | Read Committed или Serializable | Использует MVCC, хорошо справляется с фантомами |
| **MySQL (InnoDB)** | Repeatable Read                 | MVCC; фантомы возможны, но управляемы           |
| **SQL Server**     | Read Committed                  | Поддерживает уровни Snapshot и Serializable     |
| **Oracle**         | Read Committed                  | Реализует через неблокирующее чтение            |
