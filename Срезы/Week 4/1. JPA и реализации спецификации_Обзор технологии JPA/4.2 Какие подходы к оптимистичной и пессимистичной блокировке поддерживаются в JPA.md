# üß† –ó–∞—á–µ–º –≤–æ–æ–±—â–µ –Ω—É–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
–ö–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–¥–Ω–∏–º–∏ –∏ —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏, –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã:
- ‚ùå **Lost update** ‚Äî –æ–¥–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞—Ç–∏—Ä–∞–µ—Ç –¥—Ä—É–≥–æ–µ.
- ‚ùå **Dirty read** ‚Äî —á—Ç–µ–Ω–∏–µ –Ω–µ–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- ‚ùå **Non-repeatable read** ‚Äî –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –¥—Ä—É–≥–∏–µ.
–ß—Ç–æ–±—ã —ç—Ç–æ–≥–æ –∏–∑–±–µ–∂–∞—Ç—å, JPA (—á–µ—Ä–µ–∑ Hibernate, EclipseLink –∏ –¥—Ä.) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–¥–≤–∞ –ø–æ–¥—Ö–æ–¥–∞:**
1. **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** ‚Äî ‚Äú–≤–µ—Ä—é, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –Ω–µ –±—É–¥–µ—Ç‚Äù
2. **–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** ‚Äî ‚Äú–Ω–∏–∫–æ–º—É –Ω–µ –¥–∞—é —Ç—Ä–æ–≥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞ –Ω–µ –∑–∞–∫–æ–Ω—á—É‚Äù
# üß© 1. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (Optimistic Locking)
üìå **–ò–¥–µ—è:**  
–ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –æ–¥–Ω—É –∑–∞–ø–∏—Å—å, –Ω–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ JPA –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –æ–Ω–∞ —Å –º–æ–º–µ–Ω—Ç–∞ —á—Ç–µ–Ω–∏—è.
## ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞: `@Version`
–î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ —Å—É—â–Ω–æ—Å—Ç—å:
```java
@Entity
public class Account {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private BigDecimal balance;

    @Version
    private Long version;
}
```
üß† –¢–µ–ø–µ—Ä—å JPA –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `version`
2. –ü—Ä–∏ `UPDATE` –¥–æ–±–∞–≤–ª—è—Ç—å —É—Å–ª–æ–≤–∏–µ:
    ```sql
    UPDATE account SET balance=?, version=? WHERE id=? AND version=?
    ```
3. –ï—Å–ª–∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ = 0 ‚Üí –±—Ä–æ—Å–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:
    ```java
    javax.persistence.OptimisticLockException
    ```
## üîß –ü—Ä–∏–º–µ—Ä –≤ –∫–æ–¥–µ
```java
@Transactional
public void updateBalance(Long id, BigDecimal newBalance) {
    Account account = em.find(Account.class, id);
    account.setBalance(newBalance);
    // JPA —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–µ—Ä—Å–∏—é –ø—Ä–∏ commit()
}
```
–ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–π –∏–∑–º–µ–Ω–∏–ª —Ç—É –∂–µ –∑–∞–ø–∏—Å—å —Ä–∞–Ω—å—à–µ ‚Äî –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ –≤—ã–±—Ä–æ—Å–∏—Ç—Å—è `OptimisticLockException`.
## üß© –¢–∏–ø—ã –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
–ú–æ–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏:
```java
em.find(Account.class, id, LockModeType.OPTIMISTIC);
em.find(Account.class, id, LockModeType.OPTIMISTIC_FORCE_INCREMENT);
```

|–¢–∏–ø|–û–ø–∏—Å–∞–Ω–∏–µ|
|---|---|
|`OPTIMISTIC`|–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ|
|`OPTIMISTIC_FORCE_INCREMENT`|–¢–æ –∂–µ, –Ω–æ **—Å—Ä–∞–∑—É —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–µ—Ä—Å–∏—é**, –¥–∞–∂–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π|
# üîí 2. –ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (Pessimistic Locking)
üìå **–ò–¥–µ—è:**  
–ö–∞–∫ —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å —á–∏—Ç–∞–µ—Ç—Å—è ‚Äî –æ–Ω–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î, –∏ –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ **–∂–¥—É—Ç**, –ø–æ–∫–∞ –ø–µ—Ä–≤–∞—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
## ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```java
Account account = em.find(Account.class, id, LockModeType.PESSIMISTIC_WRITE);
```
–∏–ª–∏ —á–µ—Ä–µ–∑ `Query`:
```java
em.createQuery("SELECT a FROM Account a WHERE a.id = :id", Account.class)
  .setParameter("id", id)
  .setLockMode(LockModeType.PESSIMISTIC_WRITE)
  .getSingleResult();
```
## üîß –¢–∏–ø—ã –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

|LockModeType|SQL-—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç|–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ|
|---|---|---|
|`PESSIMISTIC_READ`|`SELECT ... FOR SHARE` / `LOCK IN SHARE MODE`|–†–∞–∑—Ä–µ—à–∞–µ—Ç —á—Ç–µ–Ω–∏–µ, –Ω–æ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ|
|`PESSIMISTIC_WRITE`|`SELECT ... FOR UPDATE`|–ë–ª–æ–∫–∏—Ä—É–µ—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏|
|`PESSIMISTIC_FORCE_INCREMENT`|`FOR UPDATE` + —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏|–°–æ–≤–º–µ—â–∞–µ—Ç –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–µ–º|
## ‚öôÔ∏è –ü—Ä–∏–º–µ—Ä –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
```java
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    Account from = em.find(Account.class, fromId, LockModeType.PESSIMISTIC_WRITE);
    Account to = em.find(Account.class, toId, LockModeType.PESSIMISTIC_WRITE);

    from.setBalance(from.getBalance().subtract(amount));
    to.setBalance(to.getBalance().add(amount));
}
```
‚úÖ –¢–µ–ø–µ—Ä—å –Ω–∏–∫—Ç–æ –Ω–µ —Å–º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –∑–∞–ø–∏—Å–∏, –ø–æ–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
# ‚ö†Ô∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

|–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞|–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è|–ü–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω–∞—è|
|---|---|---|
|–¢–∏–ø –∫–æ–Ω—Ç—Ä–æ–ª—è|–ß–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–µ –ø–æ–ª–µ|–ß–µ—Ä–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –ë–î|
|–ó–∞—Ç—Ä–∞—Ç—ã|–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ|–í—ã—Å–æ–∫–∏–µ (–æ–∂–∏–¥–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫)|
|–ö–æ–Ω—Ñ–ª–∏–∫—Ç|–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ `commit()`|–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É|
|–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å|–õ—É—á—à–µ –ø—Ä–∏ –Ω–∏–∑–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏|–õ—É—á—à–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏|
|–ü–æ–¥–¥–µ—Ä–∂–∫–∞|`@Version`|`LockModeType.PESSIMISTIC_*`|
|–ò—Å–∫–ª—é—á–µ–Ω–∏—è|`OptimisticLockException`|`PessimisticLockException`, `LockTimeoutException`|
# üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É–π **–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É** –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—á–µ—Ä–µ–∑ `@Version`)  
    ‚Üí —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è 90% —Å–ª—É—á–∞–µ–≤.
- –ü—Ä–∏–º–µ–Ω—è–π **–ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É** —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
    - –≤—ã—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞,
    - –Ω—É–∂–Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äú–≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ‚Äù (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö).
# üîç –ë–æ–Ω—É—Å: —Ä—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Lock Mode –≤ Spring Data JPA
```java
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT a FROM Account a WHERE a.id = :id")
Optional<Account> findAndLock(@Param("id") Long id);
```