# ‚úÖ **–ß—Ç–æ —Ç–∞–∫–æ–µ MFA –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ Spring Security?**
MFA (–æ–±—ã—á–Ω–æ 2FA) ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ª–æ–≥–∏–Ω + –ø–∞—Ä–æ–ª—å** ‚Üí –ø–µ—Ä–≤–∞—è —Å—Ç—É–ø–µ–Ω—å
2. **–°–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –≤—Ç–æ—Ä–æ–π —Ñ–∞–∫—Ç–æ—Ä** (–∫–æ–¥ TOTP / SMS / e-mail / push) ‚Üí –≤—Ç–æ—Ä–∞—è —Å—Ç—É–ø–µ–Ω—å
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–¥–∞–µ—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω (JWT) –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è.
# üß© **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ MFA –Ω–∞ Spring Security**
–¢–∏–ø–∏—á–Ω–∞—è —Å—Ö–µ–º–∞:
```
[Login Page / JSON login] ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω+–ø–∞—Ä–æ–ª—å
        |
        ‚Üì
[Need MFA?] ‚Üí No ‚Üí –≤—ã–¥–∞–µ–º –æ–±—ã—á–Ω—ã–π JWT/—Å–µ—Å—Å–∏—é ‚Üí –≤—Ö–æ–¥
        |
        Yes ‚Üí
        ‚Üì
[–ì–µ–Ω–µ—Ä–∞—Ü–∏—è TOTP/SMS/Email –∫–æ–¥–∞]
        |
        ‚Üì
[–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è /verify-mfa endpoint]
        |
        ‚Üì
–í—ã–¥–∞—ë–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π JWT / —Å–µ—Å—Å–∏—é
```
# üöÄ **–®–∞–≥ 1. –í–∫–ª—é—á–∏—Ç—å Spring Security**
```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {
}
```
# üöÄ **–®–∞–≥ 2. –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ñ–ª–∞–≥–æ–º MFA**
```java
public class UserEntity {
    private String username;
    private String password;
    private boolean mfaEnabled;
    private String mfaSecret; // –¥–ª—è TOTP –∏–ª–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
}
```
# üöÄ **–®–∞–≥ 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–≤—É—é —Ñ–∞–∑—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø–∞—Ä–æ–ª—å)**
–°–æ–∑–¥–∞—ë–º –æ–±—ã—á–Ω—É—é —Ñ–æ—Ä–º—É/endpoint –ª–æ–≥–∏–Ω–∞:
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .csrf(csrf -> csrf.disable())
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/auth/login", "/auth/verify-mfa").permitAll()
            .anyRequest().authenticated()
        )
        .formLogin(form -> form.disable())
        .sessionManagement(session ->
            session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        );

    return http.build();
}
```
–ú—ã —Å–∞–º–∏ –±—É–¥–µ–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ª–æ–≥–∏–Ω ‚Üí –ø–æ—ç—Ç–æ–º—É `formLogin().disable()`.
# üöÄ **–®–∞–≥ 4. –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –ª–æ–≥–∏–Ω–∞**
```java
@PostMapping("/auth/login")
public ResponseEntity<?> login(@RequestBody LoginRequest req) {
    Authentication authentication =
            authManager.authenticate(
                    new UsernamePasswordAuthenticationToken(
                            req.getUsername(),
                            req.getPassword()
                    )
            );

    UserEntity user = userService.load(req.getUsername());

    if (user.isMfaEnabled()) {
        String code = mfaService.generateCode(user); // TOTP –∏–ª–∏ random
        mfaService.sendCode(user, code);             // Email/SMS/Push
        return ResponseEntity.status(202).body("MFA_REQUIRED");
    }

    // –æ–±—ã—á–Ω—ã–π –≤—Ö–æ–¥ ‚Üí –≤—ã–¥–∞–µ–º JWT
    String token = jwtService.generateToken(user);
    return ResponseEntity.ok(new TokenResponse(token));
}
```
–ï—Å–ª–∏ MFA –≤–∫–ª—é—á–µ–Ω–∞ ‚Üí –Ω–µ –≤—ã–¥–∞—ë–º JWT.  
–û—Ç–≤–µ—á–∞–µ–º: **"MFA_REQUIRED"**.
# üöÄ **–®–∞–≥ 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ MFA**
### –í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî TOTP (Google Authenticator)
–ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É:
```
implementation 'dev.samstevens.totp:totp:1.7.1'
```
```java
@Service
public class MfaService {
    private final TimeBasedOneTimePasswordGenerator totp;

    public MfaService() throws NoSuchAlgorithmException {
        totp = new TimeBasedOneTimePasswordGenerator();
    }

    public boolean verify(String secret, String code) {
        return totp.verify(code, Base32String.decode(secret));
    }
}
```
### –í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî SMS / email
```java
public String generateCode(UserEntity user) {
    String code = String.format("%06d", new SecureRandom().nextInt(1_000_000));
    cache.put(user.getUsername(), code); // –≤—Ä–µ–º–µ–Ω–Ω–æ
    return code;
}
```
# üöÄ **–®–∞–≥ 6. –°–æ–∑–¥–∞—Ç—å endpoint –≤—Ç–æ—Ä–æ–≥–æ —Ñ–∞–∫—Ç–æ—Ä–∞**
```java
@PostMapping("/auth/verify-mfa")
public ResponseEntity<?> verify(@RequestBody MfaVerifyRequest req) {
    UserEntity user = userService.load(req.getUsername());

    if (!mfaService.verify(user.getMfaSecret(), req.getCode())) {
        return ResponseEntity.status(403).body("INVALID_CODE");
    }

    String token = jwtService.generateToken(user);
    return ResponseEntity.ok(new TokenResponse(token));
}
```
–ù–∞ —ç—Ç–æ–º —à–∞–≥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **—Ñ–∏–Ω–∞–ª—å–Ω—ã–π JWT**.
# üöÄ **–®–∞–≥ 7. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä JWT, —á—Ç–æ–±—ã –∑–∞—â–∏—â–∞—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã**
–£ –≤–∞—Å, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —É–∂–µ –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä:
```java
public class JwtAuthFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain chain) throws IOException, ServletException {

        String jwt = extractToken(request);
        if (jwt != null && jwtService.validate(jwt)) {
            UserDetails user = userService.load(jwtService.extractUsername(jwt));

            UsernamePasswordAuthenticationToken auth =
                    new UsernamePasswordAuthenticationToken(
                            user, null, user.getAuthorities());

            SecurityContextHolder.getContext().setAuthentication(auth);
        }

        chain.doFilter(request, response);
    }
}
```
# üß© **–ò—Ç–æ–≥–æ ‚Äî MFA —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:**

|–≠—Ç–∞–ø|–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç|
|---|---|
|1. /auth/login|–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å|
||–ï—Å–ª–∏ MFA –≤–∫–ª—é—á–µ–Ω–∞ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ–º MFA_REQUIRED|
|2. /auth/verify-mfa|–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥|
||–í—ã–¥–∞—ë–º JWT|
|3. –ó–∞—â–∏—Ç–∞ —Ä–µ—Å—É—Ä—Å–æ–≤|JWT-–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è|
