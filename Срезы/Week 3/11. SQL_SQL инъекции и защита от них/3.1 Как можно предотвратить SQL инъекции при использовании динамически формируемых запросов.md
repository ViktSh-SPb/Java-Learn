# 1. Главное правило
**Никогда не встраивайте необработанные пользовательские данные в текст SQL-запроса.**  
Данные должны передаваться отдельно от структуры запроса (параметры), а любые динамические части SQL (имена таблиц/столбцов, ORDER BY) — строго верифицироваться (whitelist).
# 2. Используйте параметризованные запросы / prepared statements
Это первейшая защита: значения подставляются как параметры, а СУБД трактует их как данные, а не как SQL.
Java (JDBC):
```java
String sql = "SELECT * FROM users WHERE email = ?";
PreparedStatement ps = conn.prepareStatement(sql);
ps.setString(1, userInputEmail);
ps.executeQuery();
```
# 3. Для динамической структуры SQL — используйте белые списки (whitelists)
Нельзя параметризовать идентификаторы (имена таблиц/столбцов). Решение — заранее хранить список разрешённых значений и выбирать из него.
Пример: безопасный `ORDER BY`
```java
Map<String,String> allowed = Map.of("name","name","date","created_at");
String sort = allowed.getOrDefault(userInputSort, "name");
String sql = "SELECT * FROM items ORDER BY " + sort + " LIMIT ?";
/* остальное — параметры */
```
Ни в коем случае не использовать `ORDER BY` + userInputSort напрямую.
# 4. Безопасно строим `IN`-списки и массивы параметров
Нельзя подставлять `(... , userInputList , ...)` как строку. Создавайте placeholders динамически и передавайте значения как параметры.
В PostgreSQL можно использовать массив-параметр:
```sql
SELECT * FROM table WHERE id = ANY(%s)
```
и передать список как параметр.
# 5. Используйте ORM / query builders, но осторожно
ORM (Hibernate, SQLAlchemy, Django ORM) обычно параметризует значения. Но **не доверяйте raw SQL** в ORM без параметров. Для динамических частей используйте API ORM (поле, порядок) или проверяйте через whitelist.
# 6. Хранимые процедуры — с параметрами
Если у вас логика в базе, используйте хранимые процедуры / функции и передавайте параметры. Не генерируйте динамический SQL внутри процедуры без параметров и строгой валидации.
# 7. Минимизируйте привилегии пользователя БД
Даже при уязвимости параметризированного запроса приложение не должно иметь лишних прав (DROP, ALTER и т. п.). Принцип наименьших привилегий снижает риск.
# 8. Валидация входных данных (whitelist > blacklist)
Для полей с ожидаемыми форматом/диапазоном проверяйте:
- числа — парсить в int/long,
- даты — парсить в тип DATE/TIME,
- перечисления — сверять по списку допустимых значений.
# 9. Логирование, мониторинг и WAF
- Логи SQL-ошибок/запросов помогут обнаружить подозрительную активность.
- WAF может блокировать типичные паттерны SQLi.
- SAST/DAST и периодические pentest’ы обязательны.
# 10. Примеры безопасного динамического построения запроса
Построим фильтр с dynamic WHERE и ORDER BY безопасно (псевдокод):
```java
String base = "SELECT * FROM products WHERE 1=1";
List<Object> params = new ArrayList<>();

if (category != null) {
  base += " AND category = ?";
  params.add(category);
}
if (minPrice != null) {
  base += " AND price >= ?";
  params.add(minPrice);
}

/* whitelist для сортировки */
Map<String,String> cols = Map.of("price","price","name","name","created","created_at");
String orderColumn = cols.getOrDefault(sortParam, "created_at");
base += " ORDER BY " + orderColumn + (desc ? " DESC" : " ASC");

PreparedStatement ps = conn.prepareStatement(base);
for (int i = 0; i < params.size(); i++) ps.setObject(i+1, params.get(i));
ps.executeQuery();
```
# 11. Что делать, если надо подставлять имя таблицы/колонки динамически
- Всё равно использовать whitelist: маппинг ключ → реальное имя таблицы.
- Либо использовать заранее подготовленные SQL-шаблоны для каждого варианта и выбирать нужный шаблон по ключу.
Ни в коем случае не принимать произвольные строки и не экранировать их как данные — экранирование идентификаторов ненадёжно.
# 12. Дополнительные практики безопасности
- Отключить возможность выполнения нескольких операторов в одном запросе (если driver/SGBD поддерживает).
- Обновлять СУБД и драйверы (патчи).
- Использовать ограничение максимальной длины и типов входа.
- Проводить code review фрагментов, где формируется SQL.
# 13. Короткий чеклист для PR / ревью кода
- Все значения в SQL — параметры? ✅
- Любые динамические идентификаторы — из whitelist? ✅
- Нельзя выполнить `; DROP` и т.п.? ✅
- Пользователь БД имеет минимальные права? ✅
- Логи/мониторинг на месте? ✅