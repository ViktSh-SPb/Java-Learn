## 🔹 Что такое CAS (Compare-And-Swap / Compare-And-Set)
**CAS** — это атомарная операция низкого уровня, используемая в многопоточном программировании для **обновления значения переменной без блокировок**.
- **Идея:** изменить значение переменной только если оно **не изменилось с момента последней проверки**.
- Используется в **атомарных классах** (`AtomicInteger`, `AtomicReference`), неблокирующих структурах данных и **lock-free алгоритмах**.
## 🔹 Как работает CAS
CAS имеет три параметра:
1. **memory location** — адрес переменной, которую хотим изменить.
2. **expected value** — значение, которое мы ожидаем увидеть.
3. **new value** — новое значение, которое хотим записать.
Алгоритм:

```
если (текущее значение == expected value) {
    установить новое значение
    вернуть true
} иначе {
    вернуть false
}
```
- Если переменная изменилась другим потоком, CAS **не изменяет значение и возвращает false**.
- Поток обычно повторяет попытку (loop) до успеха — это называется **spin loop**.
## 🔹 Пример использования в Java
```java
import java.util.concurrent.atomic.AtomicInteger;

public class CasExample {
    private static AtomicInteger counter = new AtomicInteger(0);

    public static void main(String[] args) {
        Runnable task = () -> {
            for (int i = 0; i < 1000; i++) {
                int oldValue;
                int newValue;
                do {
                    oldValue = counter.get();
                    newValue = oldValue + 1;
                } while (!counter.compareAndSet(oldValue, newValue));
            }
        };

        Thread t1 = new Thread(task);
        Thread t2 = new Thread(task);
        t1.start();
        t2.start();
        try {
            t1.join();
            t2.join();
        } catch (InterruptedException e) { }

        System.out.println("Final count: " + counter.get());
    }
}
```
- `compareAndSet(oldValue, newValue)` — CAS операция.
- **Без блокировок**, безопасно для нескольких потоков.
## 🔹 Преимущества CAS
1. **Без блокировок (Lock-free)** → уменьшает вероятность deadlock.
2. **Быстрое выполнение** → нет затрат на синхронизацию потоков через `synchronized` или `Lock`.
3. Используется в **атомарных классах и неблокирующих структурах** (ConcurrentLinkedQueue, ConcurrentHashMap).
## 🔹 Недостатки CAS
1. **Spin-loop** → высокое потребление CPU при высокой конкуренции.
2. **ABA-проблема**: переменная изменилась с A→B→A, CAS считает, что изменений не было.
    - Решается использованием `AtomicStampedReference` или `AtomicMarkableReference`.
## 🔹 Итог
- **CAS** — это атомарная проверка и установка значения.
- Позволяет создавать **lock-free многопоточные алгоритмы**.
- Широко используется в **Concurrent структурах данных и атомарных переменных**.