## 1️⃣ **Cache Stampede (Штамповка кэша)**
**Проблема:**
- Одновременно много запросов к **одному ключу**, которого нет в кэше.
- Все запросы идут в базу данных → нагрузка падает на бэкенд.
**Решения:**
1. **Mutex / Locking**
    - Перед запросом к базе ставим "замок" в Redis (`SETNX`).
    - Один поток загружает данные, остальные ждут.
```java
if (redis.setIfAbsent("lock:user:1", "1", 5, TimeUnit.SECONDS)) {
    // ключа нет, загружаем из БД
}
```
2. **Early recomputation / Random TTL**
    - Обновлять кэш заранее до истечения TTL.
    - Добавлять случайный разброс к TTL, чтобы разные ключи не истекали одновременно.
## 2️⃣ **Cache Avalanche (Каскадный отказ кэша)**
**Проблема:**
- Много ключей истекают **одновременно**, что приводит к резкому росту запросов к базе данных.
**Решения:**
1. **Случайный TTL (Random Expiration)**
    - Добавлять небольшой рандом к TTL:
```java
long ttl = 3600 + new Random().nextInt(300); // 1 час ±5 минут
redisTemplate.opsForValue().set(key, value, ttl, TimeUnit.SECONDS);
```
2. **Стадная перезагрузка (Gradual recomputation)**
    - Обновлять кэш постепенно, а не все сразу.
3. **Cache pre-warming**
    - Загружать популярные ключи заранее при старте приложения.
## 3️⃣ **Cache Penetration (Пробитие кэша)**
**Проблема:**
- Запросы к несуществующим ключам обходят кэш → идут в базу данных.
- Особенно критично при атаках (сгенерированные случайные ключи).
**Решения:**
1. **Кэшировать пустые результаты**
    - Если ключа нет в БД, сохраняем **пустое значение или null** в Redis с коротким TTL (например, 1–5 минут).
```java
if (value == null) {
    redisTemplate.opsForValue().set(key, "NULL", 300, TimeUnit.SECONDS);
}
```
2. **Валидация ключей**
    - Проверять формат и диапазон ключей перед запросом к базе.
    - Отклонять очевидно неправильные запросы.
## 4️⃣ **Дополнительные рекомендации**
- **Лимитировать одновременные запросы** к одним данным (Rate limiting).
- **Использовать Bloom Filter** для предотвращения запросов к несуществующим ключам.
- **Мониторинг TTL и кэш-хитов** для раннего обнаружения проблем.
### ✅ Итог

|Проблема|Причина|Решение|
|---|---|---|
|Cache Stampede|Много запросов к отсутствующему ключу|Lock/Mutex, Early recomputation|
|Cache Avalanche|Одновременное истечение многих ключей|Random TTL, Gradual recomputation, Pre-warming|
|Cache Penetration|Запросы к несуществующим ключам|Cache empty results, Validate keys, Bloom Filter|
